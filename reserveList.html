<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
<link rel="stylesheet" href="reservationsPortalStyle.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Reservations Portal</title>

</head>

<body>
    <div class="table-container">

    <table>

        <thead>

            <tr>

                <th>Name</th>

                <th>Room</th>

                <th>Date</th>

                <th>Time</th>

                <th>Umbrellas</th>

            </tr>

        </thead>

        <tbody id="reservationsTable"></tbody>

    </table>

</div>



<button id="deleteBtn" style="display:none;">Delete Selected</button>
<textarea id="notesTextField" style="display:none;">Notes</textarea>

<div class="footer">Copyrights Â© 2025 Toumpas Dimitris</div>

<script type="module">

import { db } from "./firebase.js";
import { collection, setDoc, getDocs, deleteDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

const tableBody = document.getElementById("reservationsTable");
const deleteBtn = document.getElementById("deleteBtn");
const notesField = document.getElementById("notesTextField");
let selectedRows = [];  // Store selected rows
let selectedDocIds = []; // Store selected document IDs

async function loadReservations() {
    tableBody.innerHTML = "";
    //selectedRows = [];
    //selectedDocIds = [];
    deleteBtn.style.display = "none"; // Hide delete button initially

    const querySnapshot = await getDocs(collection(db, "reservations"));

    querySnapshot.forEach((reservation) => {
        const data = reservation.data();
        const row = document.createElement("tr");
        row.setAttribute("data-id", reservation.id); // Store Firestore doc ID

        row.innerHTML = `
            <td>${data.name}</td>
            <td>${data.room}</td>
            <td>${data.date}</td>
            <td>${data.time}</td>
            <td contenteditable="true" class="editable">${data.umbrellas}</td>
        `;

        // Handle row selection
        let pressTimer;
        function startPressTimer() {
            pressTimer = setTimeout(() => {
                toggleRowSelection(row);
            }, 500); // 500ms long press
        }

        function clearPressTimer() {
            clearTimeout(pressTimer);
        }

        row.addEventListener("mousedown", startPressTimer);
        row.addEventListener("mouseup", clearPressTimer);
        row.addEventListener("mouseleave", clearPressTimer);

        row.addEventListener("touchstart", startPressTimer);
        row.addEventListener("touchend", clearPressTimer);
        row.addEventListener("touchcancel", clearPressTimer);

        // Event listener for updating the Umbrellas value
        row.querySelector(".editable").addEventListener("blur", async function () {
            let newValue = this.innerText.trim().split(' ');
            await updateDoc(doc(db, "reservations", row.getAttribute('data-id')), {
                umbrellas: newValue
            });
            loadReservations();
        });

        // Call the `addNotes` function when the user clicks/taps out of the `notesField`
        notesField.addEventListener('blur', function() {
        
        addNotes(selectedRows);
        });

        tableBody.appendChild(row);
    });
}

// Toggle row selection
function toggleRowSelection(row) {
    const docId = row.getAttribute('data-id');

    if (selectedDocIds.includes(docId)) {
        // Deselect row
        selectedDocIds = selectedDocIds.filter(id => id !== docId);
        selectedRows = selectedRows.filter(r => r !== row);
        row.classList.remove("selected");
    } else {
        // Select row
        selectedDocIds.push(docId);
        selectedRows.push(row);
        row.classList.add("selected");
    }

    // Show/hide delete button
    deleteBtn.style.display = selectedDocIds.length > 0 ? "block" : "none";
    notesField.style.display = selectedDocIds.length === 1 ? "block" : "none";
}

async function addNotes(selectedRows) {
    let newNotes = notesField.value;
    try
    {
          for (const row of selectedRows) {
        {
          let docId = row.getAttribute('data-id');
          await updateDoc(doc(db, "reservations", docId), {
                notes: newNotes
            });
        }
            loadReservations();

    }catch(error)
    {
        console.error("error Updating Notes",error);
    }
} 
 

// Delete all selected rows
deleteBtn.addEventListener("click", async function () {
    if (selectedDocIds.length > 0) {
        for (let docId of selectedDocIds) {
            await deleteDoc(doc(db, "reservations", docId));
        }
        loadReservations(); // Refresh table
    }
});

  let touchStartY = 0;

window.addEventListener("touchstart", (e) => {
    touchStartY = e.touches[0].clientY;
});

window.addEventListener("touchend", (e) => {
    let touchEndY = e.changedTouches[0].clientY;
    if (touchEndY - touchStartY > 100) {  // Detects a downward swipe
        window.location.reload(); // Fully reloads the page
    }
});  

loadReservations();
    
</script>
</body>
</html>
