import { db } from "./firebase.js";
import { collection, setDoc, getDocs, deleteDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

const tableBody = document.getElementById("reservationsTable");
const deleteBtn = document.getElementById("deleteBtn");
let selectedRows = [];  // Store selected rows
let selectedDocIds = []; // Store selected document IDs

async function loadReservations() {
    tableBody.innerHTML = "";
    selectedRows = [];
    selectedDocIds = [];
    deleteBtn.style.display = "none"; // Hide delete button initially

    const querySnapshot = await getDocs(collection(db, "reservations"));

    querySnapshot.forEach((reservation) => {
        const data = reservation.data();
        const row = document.createElement("tr");
        row.setAttribute("data-id", reservation.id); // Store Firestore doc ID

        row.innerHTML = `
            <td>${data.name}</td>
            <td>${data.room}</td>
            <td>${data.date}</td>
            <td>${data.time}</td>
            <td contenteditable="true" class="editable">${data.umbrellas}</td>
        `;

        // Handle row selection
        let pressTimer;
        function startPressTimer() {
            pressTimer = setTimeout(() => {
                toggleRowSelection(row);
            }, 500); // 500ms long press
        }

        function clearPressTimer() {
            clearTimeout(pressTimer);
        }

        row.addEventListener("mousedown", startPressTimer);
        row.addEventListener("mouseup", clearPressTimer);
        row.addEventListener("mouseleave", clearPressTimer);

        row.addEventListener("touchstart", startPressTimer);
        row.addEventListener("touchend", clearPressTimer);
        row.addEventListener("touchcancel", clearPressTimer);

        // Event listener for updating the Umbrellas value
        row.querySelector(".editable").addEventListener("blur", async function () {
            let newValue = this.innerText.trim().split(' ');
            await updateDoc(doc(db, "reservations", row.getAttribute('data-id')), {
                umbrellas: newValue
            });
            loadReservations();
        });

        tableBody.appendChild(row);
    });
}

// Toggle row selection
function toggleRowSelection(row) {
    const docId = row.getAttribute('data-id');

    if (selectedDocIds.includes(docId)) {
        // Deselect row
        selectedDocIds = selectedDocIds.filter(id => id !== docId);
        selectedRows = selectedRows.filter(r => r !== row);
        row.classList.remove("selected");
    } else {
        // Select row
        selectedDocIds.push(docId);
        selectedRows.push(row);
        row.classList.add("selected");
    }

    // Show/hide delete button
    deleteBtn.style.display = selectedDocIds.length > 0 ? "block" : "none";
}

// Delete all selected rows
deleteBtn.addEventListener("click", async function () {
    if (selectedDocIds.length > 0) {
        for (let docId of selectedDocIds) {
            await deleteDoc(doc(db, "reservations", docId));
        }
        loadReservations(); // Refresh table
    }
});

loadReservations();
